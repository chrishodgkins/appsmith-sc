SELECT 
    uuid,
    MAX(externalid) as externalid,
    MAX(state) as state,
    MAX(description) as description,
    MAX(name) as name,
    MAX(CASE WHEN service_name = 'ACL' THEN service_values END) as "ACL",
    MAX(CASE WHEN service_name = 'Allocated ports' THEN service_values END) as "Allocated ports",
    MAX(CASE WHEN service_name = 'Assigned numbers' THEN service_values END) as "Assigned numbers",
    MAX(CASE WHEN service_name = 'Bot list' THEN service_values END) as "Bot list",
    MAX(CASE WHEN service_name = 'Call forwarding destination' THEN service_values END) as "Call forwarding destination",
    MAX(CASE WHEN service_name = 'Call forwarding rule' THEN service_values END) as "Call forwarding rule",
    MAX(CASE WHEN service_name = 'Call from number' THEN service_values END) as "Call from number",
    MAX(CASE WHEN service_name = 'Channel limit' THEN service_values END) as "Channel limit",
    MAX(CASE WHEN service_name = 'Channel threshold email notification' THEN service_values END) as "Channel threshold email notification",
    MAX(CASE WHEN service_name = 'CLI default number' THEN service_values END) as "CLI default number",
    MAX(CASE WHEN service_name = 'CLI Error handling' THEN service_values END) as "CLI Error handling",
    MAX(CASE WHEN service_name = 'CLI mode' THEN service_values END) as "CLI mode",
    MAX(CASE WHEN service_name = 'Contact address' THEN service_values END) as "Contact address",
    MAX(CASE WHEN service_name = 'Contact name' THEN service_values END) as "Contact name",
    MAX(CASE WHEN service_name = 'Context' THEN service_values END) as "Context",
    MAX(CASE WHEN service_name = 'Default Outbound CLI' THEN service_values END) as "Default Outbound CLI",
    MAX(CASE WHEN service_name = 'Destination' THEN service_values END) as "Destination",
    MAX(CASE WHEN service_name = 'Destination numbers' THEN service_values END) as "Destination numbers",
    MAX(CASE WHEN service_name = 'Divert to number' THEN service_values END) as "Divert to number",
    MAX(CASE WHEN service_name = 'Enable Bursting' THEN service_values END) as "Enable Bursting",
    MAX(CASE WHEN service_name = 'Enable Media Bypass' THEN service_values END) as "Enable Media Bypass",
    MAX(CASE WHEN service_name = 'Enable On-net calls' THEN service_values END) as "Enable On-net calls",
    MAX(CASE WHEN service_name = 'Inbound server/uri' THEN service_values END) as "Inbound server/uri",
    MAX(CASE WHEN service_name = 'Line/port' THEN service_values END) as "Line/port",
    MAX(CASE WHEN service_name = 'Max call rate' THEN service_values END) as "Max call rate",
    MAX(CASE WHEN service_name = 'Maximum CAPS' THEN service_values END) as "Maximum CAPS",
    MAX(CASE WHEN service_name = 'Microsoft Teams domain validation key' THEN service_values END) as "Microsoft Teams domain validation key",
    MAX(CASE WHEN service_name = 'Microsoft Teams Domain Validation Key' THEN service_values END) as "Microsoft Teams Domain Validation Key",
    MAX(CASE WHEN service_name = 'Number of channels' THEN service_values END) as "Number of channels",
    MAX(CASE WHEN service_name = 'Outbound proxy address' THEN service_values END) as "Outbound proxy address",
    MAX(CASE WHEN service_name = 'Outbound server/uri' THEN service_values END) as "Outbound server/uri",
    MAX(CASE WHEN service_name = 'Password' THEN service_values END) as "Password",
    MAX(CASE WHEN service_name = 'Region' THEN service_values END) as "Region",
    MAX(CASE WHEN service_name = 'Region Name' THEN service_values END) as "Region Name",
    MAX(CASE WHEN service_name = 'Registrar domain' THEN service_values END) as "Registrar domain",
    MAX(CASE WHEN service_name = 'Resource action' THEN service_values END) as "Resource action",
    MAX(CASE WHEN service_name = 'Routing domain' THEN service_values END) as "Routing domain",
    MAX(CASE WHEN service_name = 'Service action' THEN service_values END) as "Service action",
    MAX(CASE WHEN service_name = 'Service name' THEN service_values END) as "Service name",
    MAX(CASE WHEN service_name = 'Service Region' THEN service_values END) as "Service Region",
    MAX(CASE WHEN service_name = 'SIP' THEN service_values END) as "SIP",
    MAX(CASE WHEN service_name = 'SIP Signalling Transport Method' THEN service_values END) as "SIP Signalling Transport Method",
    MAX(CASE WHEN service_name = 'SIP Termination method' THEN service_values END) as "SIP Termination method",
    MAX(CASE WHEN service_name = 'Termination method' THEN service_values END) as "Termination method",
    MAX(CASE WHEN service_name = 'This Trunk requires masking of PII data' THEN service_values END) as "This Trunk requires masking of PII data",
    MAX(CASE WHEN service_name = 'Timezone' THEN service_values END) as "Timezone",
    MAX(CASE WHEN service_name = 'Transportation method' THEN service_values END) as "Transportation method",
    MAX(CASE WHEN service_name = 'Trunk' THEN service_values END) as "Trunk",
    MAX(CASE WHEN service_name = 'Trunk group' THEN service_values END) as "Trunk group",
    MAX(CASE WHEN service_name = 'Username' THEN service_values END) as "Username",
    MAX(CASE WHEN service_name IS NULL THEN service_values END) as "Unknown"
FROM (
    SELECT 
        uuid,
        service_name,
        string_agg(service_value, ', ' ORDER BY service_value) as service_values,
        MAX(externalid) as externalid,
        MAX(state) as state,
        MAX(description) as description,
        MAX(name) as name
    FROM ivpservices
    WHERE externalid = '{{ appsmith.store.statclick }}'
    GROUP BY uuid, service_name
) subquery
GROUP BY uuid;