WITH customer_realm_extract AS (
    -- Extract ALL cust-* realms directly from local_policy, excluding secureco
    SELECT DISTINCT
        lp.account_no,
        unnest(regexp_matches(lp.src_realm, 'cust-[a-zA-Z0-9_-]+', 'g')) as individual_realm
    FROM local_policy lp
    WHERE lp.data_source LIKE 'SYD1%'
        AND lp.src_realm IS NOT NULL
        AND lp.src_realm NOT LIKE '%secureco%'
),
customer_realm_data AS (
    -- Get other customer data from gen1_ntwk_data
    SELECT DISTINCT
        c.customer,
        c.account_no,
        c.lp_src_realm,
        c.lp_nexthop_list,
        c.flag_sema_onprem,
        c.flag_sema_cloud,
        c.lp_nextrealm_list,
        c.vocus, c.symbio, c.aapt, c.optus, c.telstra
    FROM gen1_ntwk_data c
),
customer_realms AS (
    SELECT DISTINCT
        crd.customer,
        crd.account_no,
        -- Aggregate ALL cust-* realms found
        STRING_AGG(DISTINCT cre.individual_realm, ',' ORDER BY cre.individual_realm) as customer_realm,
        -- Check if customer uses cloud-aws
        BOOL_OR(crd.lp_src_realm LIKE '%cloud-aws%' OR crd.lp_nexthop_list LIKE '%cloud-aws%') as has_cloud_aws,
        BOOL_OR(crd.flag_sema_onprem = 'true' OR crd.flag_sema_cloud = 'true') as uses_sema_payments,
        MAX(crd.lp_nextrealm_list) as dest_realms,
        BOOL_OR(
            crd.lp_src_realm LIKE '%cloud-ibmsyd%' OR crd.lp_src_realm LIKE '%cloudAzure%'
                OR crd.lp_nextrealm_list LIKE '%cloud-ibmsyd%' OR crd.lp_nextrealm_list LIKE '%cloudAzure%'
        ) as traffic_via_ibm_azure,
        BOOL_OR(crd.vocus = 'true') as vocus,
        BOOL_OR(crd.symbio = 'true') as symbio,
        BOOL_OR(crd.aapt = 'true') as aapt,
        BOOL_OR(crd.optus = 'true') as optus,
        BOOL_OR(crd.telstra = 'true') as telstra
    FROM customer_realm_data crd
    LEFT JOIN customer_realm_extract cre ON crd.account_no = cre.account_no
    GROUP BY crd.customer, crd.account_no
),
-- Extract ALL PureCloud domains from local policy hoplist for each customer
purecloud_domains AS (
    SELECT DISTINCT
        lp.account_no,
        (regexp_matches(lp.hoplist, '(sc-[a-z0-9]+\.byoc\.mypurecloud\.com\.au)', 'g'))[1] as purecloud_domain
    FROM local_policy lp
    WHERE lp.hoplist LIKE '%.mypurecloud.com.au%'
        AND lp.data_source LIKE 'SYD1%'
),
-- Get customer terminating realm session agents for ALL realms
customer_session_agents AS (
    SELECT DISTINCT
        cre.account_no,
        sa.hostname as session_agent_hostname
    FROM customer_realm_extract cre
    INNER JOIN session_agent sa
        ON cre.individual_realm = sa.realm_id
),
-- Combine all session agents
all_session_agents AS (
    SELECT account_no, session_agent_hostname as agent
    FROM customer_session_agents
    UNION ALL
    SELECT account_no, purecloud_domain as agent
    FROM purecloud_domains
),
aggregated_agents AS (
    SELECT
        account_no,
        STRING_AGG(DISTINCT agent, ',') as all_session_agents
    FROM all_session_agents
    GROUP BY account_no
),
sip_interfaces AS (
    SELECT DISTINCT
        cre.account_no,
        STRING_AGG(DISTINCT si.sipport_address, ', ') as ip_addresses
    FROM customer_realm_extract cre
    INNER JOIN sip_interface si ON cre.individual_realm = si.realm_id
    GROUP BY cre.account_no
)
SELECT DISTINCT
    cr.customer,
    cr.account_no,
    -- Build source_realm list with ALL cust-* realms plus cloud-aws if applicable
    CASE
        WHEN cr.customer_realm IS NOT NULL AND cr.has_cloud_aws THEN cr.customer_realm || ',cloud-aws'
        WHEN cr.customer_realm IS NOT NULL THEN cr.customer_realm
        WHEN cr.has_cloud_aws THEN 'cloud-aws'
        ELSE NULL
    END as source_realm,
    CONCAT_WS(', ',
        CASE WHEN cr.vocus THEN 'Vocus' END,
        CASE WHEN cr.symbio THEN 'Symbio' END,
        CASE WHEN cr.aapt THEN 'AAPT' END,
        CASE WHEN cr.optus THEN 'Optus' END,
        CASE WHEN cr.telstra THEN 'Telstra' END
    ) as carrier_connections,
    cr.uses_sema_payments,
    NULL as genesys_purecloud_domains,
    aa.all_session_agents as customer_realm_session_agents,
    si.ip_addresses as sip_interface_ips,
    cr.traffic_via_ibm_azure as gen1_ivp_backbone
FROM customer_realms cr
LEFT JOIN aggregated_agents aa ON cr.account_no = aa.account_no
LEFT JOIN sip_interfaces si ON cr.account_no = si.account_no
ORDER BY cr.customer;